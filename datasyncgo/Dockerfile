FROM golang:1.23-alpine AS builder
WORKDIR /app

ARG MONGO_USER
ARG MONGO_PASSWORD
ARG MONGO_HOST
ARG MONGO_PORT
ARG MONGO_DB
ARG BACKEND_HOST
ARG BACKEND_PORT
ARG BACKEND_USER
ARG BACKEND_PASSWORD
ARG BACKEND_KEY
ARG GIN_MODE

COPY . .
RUN apk add gcc musl-dev
RUN CC=gcc GOOS=linux GOARCH=amd64 CGO_ENABLED=1 go build -ldflags '-linkmode external -extldflags "-static"' -o datasyncgo .

FROM alpine:latest
WORKDIR /app
COPY --from=builder /app/datasyncgo .

ENV MONGO_USER=MONGO_USER
ENV MONGO_PASSWORD=MONGO_PASSWORD
ENV MONGO_HOST=MONGO_HOST
ENV MONGO_PORT=MONGO_PORT
ENV BACKEND_HOST=BACKEND_HOST
ENV BACKEND_PORT=BACKEND_PORT
ENV BACKEND_USER=BACKEND_USER
ENV BACKEND_PASSWORD=BACKEND_PASSWORD
ENV BACKEND_KEY=BACKEND_KEY
ENV GIN_MODE=GIN_MODE

EXPOSE 8082
CMD ["/app/datasyncgo"]
