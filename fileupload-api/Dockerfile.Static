FROM golang:1.23-alpine AS builder
WORKDIR /app

ARG FRONTEND_HOST
ARG FRONTEND_PORT
ARG MINIO_HOST
ARG MINIO_PORT
ARG MINIO_ACCESS_KEY_ID
ARG MINIO_SECRET_ACCESS_KEY
ARG GIN_MODE

COPY . .
RUN apk add gcc musl-dev
RUN CC=gcc GOOS=linux GOARCH=amd64 CGO_ENABLED=1 go build -ldflags '-linkmode external -extldflags "-static"' -o fileupload .

FROM alpine:latest
WORKDIR /app
COPY --from=builder /app/fileupload .

ENV FRONTEND_HOST=FRONTEND_HOST
ENV FRONTEND_PORT=FRONTEND_PORT
ENV MINIO_HOST=MINIO_HOST
ENV MINIO_PORT=MINIO_PORT
ENV MINIO_ACCESS_KEY_ID=MINIO_ACCESS_KEY_ID
ENV MINIO_SECRET_ACCESS_KEY=MINIO_SECRET_ACCESS_KEY
ENV GIN_MODE=GIN_MODE

EXPOSE 8082
CMD ["/app/fileupload"]
